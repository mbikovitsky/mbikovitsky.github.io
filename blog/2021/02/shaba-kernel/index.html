<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Shabak Challenge 2021: shabaKernel | Biko&#39;s House of Horrors</title>

    <style>body{margin:40px auto;max-width:650px;line-height:1.6;font-size:18px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}div.header h1{padding-top:0;padding-bottom:8px;margin-bottom:24px;font-size:18px;font-weight:400;border-bottom:1px solid}.header-menu{float:right}ul.pagination{list-style-type:none;text-align:center;padding:0}ul.pagination>li{padding:0 8px;display:inline-block}div.footer{border-top:1px solid;text-align:center}img{max-width:100%;max-height:100%;display:block;margin-left:auto;margin-right:auto}</style>

    <link rel="shortcut icon" href="/favicon.ico">

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Tinos&family=Ubuntu+Mono&display=swap" rel="stylesheet">

<style>
body { font-family: 'Tinos', serif; }
pre { font-family: 'Ubuntu Mono', monospace; }
code { font-family: 'Ubuntu Mono', monospace; }
</style>



</head>


<body>
<div class="header">
    <h1>
        <a href="/">Biko&#39;s House of Horrors</a>
        <div class="header-menu">
            <a href="/blog/">blog</a>
            <a href="/writing/">writing</a>
            <a href="/talks/">talks</a>
            <a href="/about/">about</a>
        </div>
    </h1>
</div>
<div id="content">

<header>
    <h1>Shabak Challenge 2021: shabaKernel</h1>
    

<div class="post-meta">
    Date &#x5b;
    <time datetime="2021-02-04">Feb 4, 2021</time>
    &#x5d;
</div>
</header>
<article>
    <p>This is part of my series of writeups on the Shabak 2021 CTF challenges.
See the complete collection <a href="https://bikodbg.com/blog/2021/01/unseen-shield/" title="Shabak Challenge 2021 table of contents">here</a>.</p>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#part-i-a-kernel-of-truth">Part I: A kernel of truth</a>
<ul>
<li><a href="#get-a-load-of-this">Get a load of this</a></li>
<li><a href="#master-builder">Master builder</a></li>
<li><a href="#this-just-in">This just in</a></li>
<li><a href="#cherry-pick">Cherry-pick</a></li>
</ul>
</li>
<li><a href="#part-ii-the-valley-of-fear">Part II: The Valley of Fear</a>
<ul>
<li><a href="#where-were-going-we-dont-need-libc">Where we&rsquo;re going we don&rsquo;t need <code>libc</code></a></li>
<li><a href="#a-skip-and-a-hop">A skip and a hop</a></li>
</ul>
</li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>The <a href="https://archive.org/download/shabak-challenge-2021/shabak-challenge-2021.zip/" title="shabaKernel challenge files">challenge</a> description reads:</p>
<blockquote>
<p>This binary is not an elf. So what is it?</p>
<p>Load the .ko file and find out&hellip;</p>
<p>Use the image:</p>
<p><a href="http://uec-images.ubuntu.com/releases/focal/release-20201210/" title="Ubuntu 20.04 LTS (Focal Fossa) [20201210]">http://uec-images.ubuntu.com/releases/focal/release-20201210/</a></p>
<p>Good luck!</p>
</blockquote>
<p>Unlike Windows, the Linux kernel API &mdash; the API inside the kernel,
not the syscall API &mdash; can, and does, change between releases. So if we&rsquo;re going to be
reversing kernel modules, we best have the correct kernel sources close to hand.</p>
<p>The supplied image is of Ubuntu 20.04, which according to <a href="https://ubuntu.com/blog/ubuntu-kernel-5-4-whats-new-with-ubuntu-20-04-lts" title="Ubuntu kernel 5.4: What's new with Ubuntu 20.04 LTS">this</a> has
kernel version 5.4. Instead of downloading the complete source tree, I found
<a href="https://elixir.bootlin.com/linux/v5.4.93/source" title="Linux source code (v5.4.93) - Bootlin">this</a> nice website that can search through the kernel sources.</p>
<p>So, let&rsquo;s get started.</p>
<h2 id="part-i-a-kernel-of-truth">Part I: A kernel of truth</h2>
<p>We take <code>loader.ko</code>, throw it into our <a href="https://ghidra-sre.org/" title="Ghidra">favorite decompiler</a>, and see what&rsquo;s
what:</p>
<p><img src="/img/shabakernel-exported-symbols.png" alt="shabaKernel exported symbols"></p>
<p>The <code>stateless_rc4</code> function hints that perhaps the other binary is encrypted with
<a href="https://en.wikipedia.org/wiki/RC4" title="RC4 - Wikipedia">RC4</a>, and the <code>build_key</code> function probably constructs the decryption key.
There&rsquo;s also <code>load_magen_binary</code> that looks like the &ldquo;main&rdquo; function here.</p>
<p>However, it accepts some unknown parameter which likely describes the binary being
loaded. So let&rsquo;s table it for now, and instead take a look at <code>init_module</code>.
This function does only one thing: calls <code>__register_binfmt</code> with the address
of the global variable <code>magen_fmt</code>.</p>
<p>This rings a bell: <a href="https://en.wikipedia.org/wiki/Binfmt_misc" title="binfmt_misc - Wikipedia">binfmt_misc</a> is the Linux kernel feature that allows
us to define custom file formats as executable. Looks like in this case we&rsquo;re dealing
with the lower-level variant of the same feature. A quick search yields
the <a href="https://elixir.bootlin.com/linux/v5.4.93/source/include/linux/binfmts.h#L102" title="binfmts.h - include/linux/binfmts.h - Linux source code (v5.4.93) - Bootlin">structure</a> being passed at registration:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">/*
</span><span style="color:#75715e"> * This structure defines the functions that are used to load the binary formats that
</span><span style="color:#75715e"> * linux accepts.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">linux_binfmt</span> {
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> lh;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">module</span> <span style="color:#f92672">*</span>module;
    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>load_binary)(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">linux_binprm</span> <span style="color:#f92672">*</span>);
    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>load_shlib)(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span>);
    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>core_dump)(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">coredump_params</span> <span style="color:#f92672">*</span>cprm);
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> min_coredump; <span style="color:#75715e">/* minimal dump size */</span>
} __randomize_layout;
</code></pre></td></tr></table>
</div>
</div><p>And, sure enough, the <code>load_binary</code> field points to our old friend <code>load_magen_binary</code>.
We also learn that the function accepts a pointer to <a href="https://elixir.bootlin.com/linux/v5.4.93/source/include/linux/binfmts.h#L17" title="binfmts.h - include/linux/binfmts.h - Linux source code (v5.4.93) - Bootlin"><code>linux_binprm</code></a>
as its only parameter. This structure is rather large, but it&rsquo;s worth our time to get it
into Ghidra, since we don&rsquo;t know yet what fields <code>load_magen_binary</code> uses.</p>
<h3 id="get-a-load-of-this">Get a load of this</h3>
<p>We can&rsquo;t put this off any longer. Time to see how the binary is loaded.</p>
<p>The <code>load_magen_binary</code> function begins with what looks like parameter validation.
The interesting bit is here:</p>
<!-- markdownlint-capture -->
<!-- markdownlint-disable -->
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-1"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-1"> 1</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-2"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-2"> 2</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-3"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-3"> 3</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-4"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-4"> 4</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-5"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-5"> 5</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-6"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-6"> 6</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-7"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-7"> 7</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-8"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-8"> 8</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-9"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-9"> 9</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-10"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-10">10</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-11"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-11">11</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-12"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-12">12</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-13"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-13">13</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-14"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-14">14</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-15"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-15">15</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-16"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-16">16</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="load-binary-raw-17"><a style="outline: none; text-decoration:none; color:inherit" href="#load-binary-raw-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">lVar6 <span style="color:#f92672">=</span> __kmalloc(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(binprm<span style="color:#f92672">-&gt;</span>buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>), <span style="color:#ae81ff">0xcc0</span>);
<span style="color:#66d9ef">if</span> (lVar6 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
  lVar7 <span style="color:#f92672">=</span> kmem_cache_alloc_trace(_DAT_001010d0, <span style="color:#ae81ff">0xcc0</span>, <span style="color:#ae81ff">0x12</span>);
  <span style="color:#66d9ef">if</span> (lVar7 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
    iVar4 <span style="color:#f92672">=</span> build_key(binprm<span style="color:#f92672">-&gt;</span>buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">9</span>,
                      lVar7,
                      <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(binprm<span style="color:#f92672">-&gt;</span>buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">9</span>,
                      <span style="color:#f92672">&amp;</span>local_44);
    <span style="color:#66d9ef">if</span> (iVar4 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
      local_40 <span style="color:#f92672">=</span> (ulong)local_44 <span style="color:#f92672">+</span> <span style="color:#ae81ff">9</span>;
      uVar10 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(binprm<span style="color:#f92672">-&gt;</span>buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">9</span> <span style="color:#f92672">-</span> local_44;
      uVar5 <span style="color:#f92672">=</span> kernel_read(binprm<span style="color:#f92672">-&gt;</span>file,
                          lVar6,
                          uVar10,
                          <span style="color:#f92672">&amp;</span>local_40);
      <span style="color:#66d9ef">if</span> (uVar10 <span style="color:#f92672">==</span> uVar5) {
        stateless_rc4(lVar7, <span style="color:#ae81ff">0x12</span>, lVar6, uVar10);</code></pre></td></tr></table>
</div>
</div>
<!-- markdownlint-restore -->
<p>This is the output from Ghidra, I just cleaned it up a little. So, what&rsquo;s going on here?</p>
<p>In <a href="#load-binary-raw-1">line 1</a>, the code reads a DWORD at offset 5 in the <code>buf</code> field
of the <code>linux_binprm</code> structure, and allocates a buffer with this size.
It&rsquo;s a fair guess that this field contains part of the binary file being loaded.
Indeed, let&rsquo;s take a look at our binary:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hexdump" data-lang="hexdump">0000h: <span style="color:#ae81ff">4D</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">47</span> <span style="color:#ae81ff">45</span> <span style="color:#ae81ff">4E</span> <span style="color:#ae81ff">19</span> <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">52</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6E</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">62</span>  <span style="color:#e6db74">MAGEN....R/bin/b</span>
0010h: <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">52</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6E</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6E</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">52</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">62</span>  <span style="color:#e6db74">ashR/bin/pingR/b</span>
0020h: <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6E</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">52</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6E</span>  <span style="color:#e6db74">in/grepR/usr/bin</span>
0030h: <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">6C</span> <span style="color:#ae81ff">6E</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">52</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6E</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6E</span>  <span style="color:#e6db74">/telnetR/sbin/in</span>
0040h: <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">52</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6E</span> <span style="color:#ae81ff">2F</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6E</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">6D</span> <span style="color:#ae81ff">6F</span> <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">52</span>  <span style="color:#e6db74">itR/sbin/insmodR</span>
0050h: <span style="color:#ae81ff">5A</span>                                               <span style="color:#e6db74">Z</span>
</code></pre></td></tr></table>
</div>
</div><p>The first 5 bytes are the magic string <code>MAGEN</code><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, and so at offset 5 we have the
DWORD <code>0x00000619 == 1561</code>. In fact, this is the exact size of the binary! Great, we&rsquo;re
making progress.</p>
<p>In <a href="#load-binary-raw-3">line 3</a> the code allocates a buffer of size <code>0x12 == 18</code>.</p>
<p>Then, in <a href="#load-binary-raw-5">lines 5-8</a>, there is a call to build the decryption key
(presumably). What&rsquo;s being passed here?</p>
<ol>
<li>The first argument is a pointer to the input buffer, at offset 9. Looking at the file,
we can see that this is the beginning of a section with a bunch of strings.</li>
<li>The second argument is the 18-byte buffer we just allocated, so presumably
this will receive the decryption key.</li>
<li>The third argument is the size of the file minus 9, so really it&rsquo;s just the size
without the magic and size fields.</li>
<li>The fourth argument points to some local variable, <code>local_44</code>.</li>
</ol>
<p>Can we deduce what that last local variable is? Later on, it&rsquo;s used in some calculations
in <a href="#load-binary-raw-10">lines 10-11</a>, and then the results are passed as arguments
to <code>kernel_read</code>. Here&rsquo;s <code>kernel_read</code>&rsquo;s <a href="https://elixir.bootlin.com/linux/v5.4.93/source/fs/read_write.c#L432" title="read_write.c - fs/read_write.c - Linux source code (v5.4.93) - Bootlin">signature</a>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">ssize_t <span style="color:#a6e22e">kernel_read</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span>file,
                    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf,
                    size_t count,
                    loff_t <span style="color:#f92672">*</span>pos);
</code></pre></td></tr></table>
</div>
</div><p>The fourth parameter is the offset within the file to read from, and we&rsquo;re passing it:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">(ulong)local_44 <span style="color:#f92672">+</span> <span style="color:#ae81ff">9</span>
</code></pre></td></tr></table>
</div>
</div><p>So <code>local_44</code> is an offset within the remainder of the file, the remainder being
what comes after the magic and size fields.</p>
<p>The third parameter is the number of bytes to read from the file, and we&rsquo;re passing it:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(binprm<span style="color:#f92672">-&gt;</span>buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">9</span> <span style="color:#f92672">-</span> local_44
</code></pre></td></tr></table>
</div>
</div><p>Which is the size of the block of bytes starting from <code>local_44 + 9</code> until the end of
the file.</p>
<p>Later on, in <a href="#load-binary-raw-17">line 17</a>, the data read from the file is passed
to the decryption function, so presumably <code>local_44 + 9</code> is the offset of the code
to be executed within the file.</p>
<p>Armed with these observations, we can now clean up the decompiled code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">pvCode <span style="color:#f92672">=</span> __kmalloc(<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(binprm<span style="color:#f92672">-&gt;</span>buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>), <span style="color:#ae81ff">0xcc0</span>);
<span style="color:#66d9ef">if</span> (pvCode <span style="color:#f92672">!=</span> NULL) {
  pcRc4Key <span style="color:#f92672">=</span> (byte <span style="color:#f92672">*</span>)kmem_cache_alloc_trace(_DAT_001010d0, <span style="color:#ae81ff">0xcc0</span>, <span style="color:#ae81ff">18</span>);
  <span style="color:#66d9ef">if</span> (pcRc4Key <span style="color:#f92672">!=</span> NULL) {
    nResult <span style="color:#f92672">=</span> build_key((byte <span style="color:#f92672">*</span>)(binprm<span style="color:#f92672">-&gt;</span>buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">9</span>),
                        pcRc4Key,
                        <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(binprm<span style="color:#f92672">-&gt;</span>buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">9</span>,
                        <span style="color:#f92672">&amp;</span>cbCodeOffset);
    <span style="color:#66d9ef">if</span> (nResult <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
      cbCodeFileOffset <span style="color:#f92672">=</span> (ulong)cbCodeOffset <span style="color:#f92672">+</span> <span style="color:#ae81ff">9</span>;
      cbCode <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(binprm<span style="color:#f92672">-&gt;</span>buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">9</span> <span style="color:#f92672">-</span> cbCodeOffset;
      uVar3 <span style="color:#f92672">=</span> kernel_read(binprm<span style="color:#f92672">-&gt;</span>file,
                          pvCode,
                          cbCode,
                          <span style="color:#f92672">&amp;</span>cbCodeFileOffset);
      <span style="color:#66d9ef">if</span> (cbCode <span style="color:#f92672">==</span> uVar3) {
        stateless_rc4(pcRc4Key, <span style="color:#ae81ff">18</span>, pvCode, cbCode);
</code></pre></td></tr></table>
</div>
</div><h3 id="master-builder">Master builder</h3>
<p>Time to see how the decryption key is constructed.</p>
<p>Ghidra does a fairly decent job of decompiling the <code>build_key</code> function,
so understanding what it does is mostly a matter of following the code.
And since the only other internal function it calls is <code>update_path</code>, there is almost no
guessing about the meaning of parameters. There are, however, several gotchas:</p>
<ul>
<li>At the very beginning of the function there is a call to <code>__fentry__</code>.
AFAICT this is part of some <a href="https://en.wikipedia.org/wiki/Ftrace" title="ftrace - Wikipedia">kernel tracing mechanism</a>, and usually this call
doesn&rsquo;t do anything. Ghidra, however, trips up on it because it thinks
it spoils some registers. The workaround I used is to <code>NOP</code>-out the call instruction
in Ghidra: right-click on the instruction in the disassembler and choose &ldquo;Patch
Instruction&rdquo;.</li>
<li>The big chunk of code in the middle of the function (<a href="#build-key-45">lines 45-48</a>)
is an optimized and/or obfuscated <code>memcpy</code>, so don&rsquo;t get stuck reversing it 😐.</li>
</ul>
<p>Here is the cleaned-up version of the code:</p>
<!-- markdownlint-capture -->
<!-- markdownlint-disable -->
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-1"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-1"> 1</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-2"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-2"> 2</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-3"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-3"> 3</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-4"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-4"> 4</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-5"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-5"> 5</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-6"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-6"> 6</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-7"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-7"> 7</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-8"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-8"> 8</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-9"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-9"> 9</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-10"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-10">10</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-11"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-11">11</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-12"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-12">12</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-13"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-13">13</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-14"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-14">14</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-15"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-15">15</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-16"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-16">16</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-17"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-17">17</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-18"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-18">18</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-19"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-19">19</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-20"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-20">20</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-21"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-21">21</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-22"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-22">22</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-23"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-23">23</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-24"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-24">24</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-25"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-25">25</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-26"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-26">26</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-27"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-27">27</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-28"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-28">28</a>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-29"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-29">29</a>
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-30"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-30">30</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-31"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-31">31</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-32"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-32">32</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-33"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-33">33</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-34"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-34">34</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-35"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-35">35</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-36"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-36">36</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-37"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-37">37</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-38"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-38">38</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-39"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-39">39</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-40"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-40">40</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-41"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-41">41</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-42"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-42">42</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-43"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-43">43</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-44"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-44">44</a>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-45"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-45">45</a>
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-46"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-46">46</a>
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-47"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-47">47</a>
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-48"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-48">48</a>
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-49"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-49">49</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-50"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-50">50</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-51"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-51">51</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-52"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-52">52</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-53"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-53">53</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-54"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-54">54</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-55"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-55">55</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-56"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-56">56</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-57"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-57">57</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-58"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-58">58</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-59"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-59">59</a>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-60"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-60">60</a>
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-61"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-61">61</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-62"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-62">62</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-63"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-63">63</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-64"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-64">64</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-65"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-65">65</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-66"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-66">66</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-67"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-67">67</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-68"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-68">68</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-69"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-69">69</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-70"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-70">70</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-71"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-71">71</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-72"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-72">72</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-73"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-73">73</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="build-key-74"><a style="outline: none; text-decoration:none; color:inherit" href="#build-key-74">74</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">build_key</span>(byte <span style="color:#f92672">*</span>pcData,
              byte <span style="color:#f92672">*</span>pcRc4Key,
              uint cbData,
              uint <span style="color:#f92672">*</span>pcbCodeOffset)
{
  <span style="color:#66d9ef">int</span> eUpdatePathResult;
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pszFilename;
  size_t cbFilename;
  size_t cbFilenameEndOffset;
  uint cbFilenameOffset;
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pcFilename;
  uint cbActualDataSize;
  uint cbFileOffset;

  <span style="color:#f92672">*</span>pcbCodeOffset <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  memset(pcRc4Key, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">18</span>);

  <span style="color:#66d9ef">if</span> ((pcData <span style="color:#f92672">!=</span> NULL)
      <span style="color:#f92672">&amp;&amp;</span> (pcRc4Key <span style="color:#f92672">!=</span> NULL)
      <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">*</span>pcData <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;R&#39;</span>)
      <span style="color:#f92672">&amp;&amp;</span> (pszFilename <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)__kmalloc(cbData <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0xcc0</span>),
          pszFilename <span style="color:#f92672">!=</span> NULL)) {
    cbFilenameEndOffset <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    cbActualDataSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x100</span>;
    <span style="color:#66d9ef">if</span> (cbData <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x101</span>) {
      cbActualDataSize <span style="color:#f92672">=</span> cbData;
    }

<span style="display:block;width:100%;background-color:#3c3d38">    cbFileOffset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5117</span>;
</span>    cbFilenameOffset <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> cbData) {
      <span style="color:#66d9ef">do</span> {
        <span style="color:#66d9ef">while</span> (true) {
          <span style="color:#66d9ef">if</span> (pcData[cbFilenameEndOffset] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Z&#39;</span>) {
            kfree(pszFilename);
            <span style="color:#f92672">*</span>pcbCodeOffset <span style="color:#f92672">=</span> cbFilenameEndOffset <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
          }
          <span style="color:#66d9ef">if</span> (pcData[cbFilenameEndOffset] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;R&#39;</span>) {
              <span style="color:#66d9ef">break</span>;
          }
          cbFilename <span style="color:#f92672">=</span> cbFilenameEndOffset <span style="color:#f92672">-</span> cbFilenameOffset;
          pcFilename <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)(pcData <span style="color:#f92672">+</span> cbFilenameOffset);

<span style="display:block;width:100%;background-color:#3c3d38">          <span style="color:#75715e">// ...
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>          <span style="color:#75715e">// Copy filename from binfmt buffer into pszFilename
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>          <span style="color:#75715e">// and add a null-terminator
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>          <span style="color:#75715e">// ...
</span></span><span style="color:#75715e"></span>
          eUpdatePathResult <span style="color:#f92672">=</span> update_path(pcRc4Key,
                                          pszFilename,
                                          cbFileOffset);
          <span style="color:#66d9ef">if</span> (eUpdatePathResult <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
          }

          cbFilenameEndOffset <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
          cbFilenameOffset <span style="color:#f92672">=</span> cbFilenameEndOffset;

<span style="display:block;width:100%;background-color:#3c3d38">          cbFileOffset <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0x11</span>;
</span>
          <span style="color:#66d9ef">if</span> (cbActualDataSize <span style="color:#f92672">&lt;=</span> cbFilenameEndOffset) {
            <span style="color:#66d9ef">goto</span> LAB_00100358;
          }
        }
        cbFilenameEndOffset <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
      } <span style="color:#66d9ef">while</span> (cbFilenameEndOffset <span style="color:#f92672">&lt;</span> cbActualDataSize);
    }
LAB_00100358:
    kfree(pszFilename);
  }

  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}</code></pre></td></tr></table>
</div>
</div>
<!-- markdownlint-restore -->
<p>Recall that the &ldquo;magen&rdquo; binary contains a fairly long string of filenames, where
each filename begins with an <code>R</code>, and the whole list is terminated with a <code>Z</code>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">R/bin/bashR/bin/pingR/bin/grepR/usr/bin/telnetR/sbin/initR/sbin/insmodRZ
</code></pre></td></tr></table>
</div>
</div><p>What <code>build_key</code> does is pass each filename to the <code>update_path</code> function
along with a file offset (but technically we don&rsquo;t know it&rsquo;s a file offset yet 😉).
For the first file, the offset is <code>0x5117</code> (see <a href="#build-key-29">line 29</a>), and it is
incremented by <code>0x11</code> for each subsequent file (<a href="#build-key-60">line 60</a>).</p>
<p>Cool, so what does <code>update_path</code> do?</p>
<h3 id="this-just-in">This just in</h3>
<p>After changing the function signature in Ghidra according to what we learned from
<code>build_key</code>, we get a pretty coherent output. Here it is, after some cleanup<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">update_path</span>(byte <span style="color:#f92672">*</span>pcRc4Key, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pszFilename, uint cbOffset)
{
  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>file;
  byte <span style="color:#f92672">*</span>buf;
  ssize_t cbReadBytes;
  size_t nIndex;
  <span style="color:#66d9ef">int</span> eResult;
  loff_t cbOffset_;

  cbOffset_ <span style="color:#f92672">=</span> cbOffset;
  file <span style="color:#f92672">=</span> filp_open(pszFilename, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">if</span> (file <span style="color:#f92672">&lt;</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xfffffffffffff001</span>) {
    buf <span style="color:#f92672">=</span> (byte <span style="color:#f92672">*</span>)kmem_cache_alloc_trace(_DAT_001010d0, <span style="color:#ae81ff">0xcc0</span>, <span style="color:#ae81ff">18</span>);
    <span style="color:#66d9ef">if</span> (buf <span style="color:#f92672">==</span> NULL) {
      eResult <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    }
    <span style="color:#66d9ef">else</span> {
      cbReadBytes <span style="color:#f92672">=</span> kernel_read(file, buf, <span style="color:#ae81ff">18</span>, <span style="color:#f92672">&amp;</span>cbOffset_);
      eResult <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
      <span style="color:#66d9ef">if</span> (cbReadBytes <span style="color:#f92672">==</span> <span style="color:#ae81ff">18</span>) {
        nIndex <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">do</span> {
          pcRc4Key[nIndex] <span style="color:#f92672">=</span> pcRc4Key[nIndex] <span style="color:#f92672">^</span> buf[nIndex];
          nIndex <span style="color:#f92672">=</span> nIndex <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        } <span style="color:#66d9ef">while</span> (nIndex <span style="color:#f92672">!=</span> <span style="color:#ae81ff">18</span>);
        eResult <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      }
      kfree(buf);
    }
    filp_close(file, NULL);
  }
  <span style="color:#66d9ef">else</span> {
    eResult <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }
  <span style="color:#66d9ef">return</span> eResult;
}
</code></pre></td></tr></table>
</div>
</div><p>So we&rsquo;re reading 18 bytes (which is precisely the key size) from the file and XORing
the existing key with these bytes. Cool.</p>
<h3 id="cherry-pick">Cherry-pick</h3>
<p>We now know all we need in order to decrypt the binary. Here&rsquo;s how we do it:</p>
<ol>
<li>Get all the files needed to construct the key from the <a href="http://uec-images.ubuntu.com/releases/focal/release-20201210/" title="Ubuntu 20.04 LTS (Focal Fossa) [20201210]">image</a>.</li>
<li>Extract 18 bytes from each file. Start from offset <code>0x5117</code> in the first file, and
increment the offset by <code>0x11</code> for each subsequent file.</li>
<li>XOR all these arrays to produce an 18-byte key.</li>
<li>Decrypt the remainder of the binary with this key, and the RC4 algorithm<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.</li>
</ol>
<p>After decryption we get a binary with some strings in it, such as
<code>&quot;Good work my friend, go submit the flag&quot;</code>, so it looks like we got it right 🥳.</p>
<h2 id="part-ii-the-valley-of-fear">Part II: The Valley of Fear</h2>
<p>We take our decrypted binary, throw it into Ghidra, and set the language to
<code>x86:LE:64:default:gcc</code>. Initially, it&rsquo;s a whole lot of nothing:</p>
<p><img src="/img/shabakernel-shellcode.png" alt="Decrypted binary - first open"></p>
<p>Assuming that execution begins at the start of the shellcode, we hit the <code>D</code> key
and lo and behold: it&rsquo;s a jump deeper down. Here&rsquo;s what we get:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span>(<span style="color:#66d9ef">void</span>)
{
  <span style="color:#66d9ef">int</span> iVar1;
  <span style="color:#66d9ef">long</span> lVar2;
  <span style="color:#66d9ef">long</span> lVar3;

  lVar2 <span style="color:#f92672">=</span> FUN_0000015f(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">if</span> (lVar2 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
    FUN_0000003c(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0x397</span>,<span style="color:#ae81ff">4</span>);
  }
  <span style="color:#66d9ef">else</span> {
    lVar2 <span style="color:#f92672">=</span> FUN_000000d8(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x18</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0x22</span>,<span style="color:#ae81ff">0xffffffff</span>,<span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">if</span> (lVar2 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
      FUN_0000003c(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0x39c</span>,<span style="color:#ae81ff">5</span>);
    }
    <span style="color:#66d9ef">else</span> {
      lVar3 <span style="color:#f92672">=</span> FUN_000000d8(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xf0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0x22</span>,<span style="color:#ae81ff">0xffffffff</span>,<span style="color:#ae81ff">0</span>);
      <span style="color:#66d9ef">if</span> (lVar3 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        FUN_0000003c(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0x39c</span>,<span style="color:#ae81ff">5</span>);
      }
      <span style="color:#66d9ef">else</span> {
        iVar1 <span style="color:#f92672">=</span> FUN_00000285(lVar2);
        <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
          iVar1 <span style="color:#f92672">=</span> FUN_00000010(<span style="color:#ae81ff">0</span>,lVar3,<span style="color:#ae81ff">0xf0</span>);
          <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x19</span>) {
            iVar1 <span style="color:#f92672">=</span> FUN_00000200(lVar3,lVar2,<span style="color:#ae81ff">0x18</span>,lVar2);
            <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
              FUN_0000003c(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0x3d0</span>,<span style="color:#ae81ff">0x28</span>);
            }
            <span style="color:#66d9ef">else</span> {
              FUN_0000003c(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0x3a8</span>,<span style="color:#ae81ff">0x22</span>);
            }
          }
          <span style="color:#66d9ef">else</span> {
            FUN_0000003c(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0x3a8</span>,<span style="color:#ae81ff">0x22</span>);
          }
        }
        FUN_00000121(lVar3,<span style="color:#ae81ff">0xf0</span>);
      }
      FUN_00000121(lVar2,<span style="color:#ae81ff">0x18</span>);
    }
  }
  FUN_00000145(<span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">return</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>Not <em>too</em> bad, all things considered. No complicated control flow here, just plain old
&ldquo;call API, exit if it fails&rdquo;. Let&rsquo;s see where this leads us.</p>
<h3 id="where-were-going-we-dont-need-libc">Where we&rsquo;re going we don&rsquo;t need <code>libc</code></h3>
<p>Looking at the first function, it&rsquo;s a wrapper around syscall number <code>0x65</code>:</p>
<p><img src="/img/shabakernel-syscall-65.png" alt="Syscall 0x65 wrapper assembly"></p>
<p>Now, I have no idea what syscall <code>0x65</code> is, but <a href="https://chromium.googlesource.com/chromiumos/docs/+/HEAD/constants/syscalls.md" title="Chromium OS Docs - Linux System Call Table">this</a> page does. Apparently,
this is <code>ptrace</code>. Combined with the appropriate <code>man</code> page we can set the correct
signature for this wrapper function. In fact, most of the functions here are syscall
wrappers, and we can make quick work of them.</p>
<p>Here&rsquo;s what the code looks like now<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span>(<span style="color:#66d9ef">void</span>)
{
  <span style="color:#66d9ef">int</span> iVar1;
  <span style="color:#66d9ef">long</span> lVar2;
  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr;
  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf;
  ssize_t sVar3;

  lVar2 <span style="color:#f92672">=</span> ptrace(PTRACE_TRACEME,<span style="color:#ae81ff">0</span>,NULL,NULL);
  <span style="color:#66d9ef">if</span> (lVar2 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
    write(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;Bye</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">4</span>);
  }
  <span style="color:#66d9ef">else</span> {
    addr <span style="color:#f92672">=</span> mmap(NULL,<span style="color:#ae81ff">0x18</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0x22</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">if</span> (addr <span style="color:#f92672">==</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>) {
      write(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;mmap</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">5</span>);
    }
    <span style="color:#66d9ef">else</span> {
      buf <span style="color:#f92672">=</span> mmap(NULL,<span style="color:#ae81ff">0xf0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0x22</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>);
      <span style="color:#66d9ef">if</span> (buf <span style="color:#f92672">==</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>) {
        write(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;mmap</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">5</span>);
      }
      <span style="color:#66d9ef">else</span> {
        iVar1 <span style="color:#f92672">=</span> FUN_00000285(addr);
        <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
          sVar3 <span style="color:#f92672">=</span> read(<span style="color:#ae81ff">0</span>,buf,<span style="color:#ae81ff">0xf0</span>);
          <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">int</span>)sVar3 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x19</span>) {
            iVar1 <span style="color:#f92672">=</span> FUN_00000200(buf,addr,<span style="color:#ae81ff">0x18</span>,addr);
            <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
              write(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;Good work my friend, go submit the flag</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">0x28</span>);
            }
            <span style="color:#66d9ef">else</span> {
              write(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;This is not the right flag, Buddy</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">0x22</span>);
            }
          }
          <span style="color:#66d9ef">else</span> {
            write(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;This is not the right flag, Buddy</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">0x22</span>);
          }
        }
        munmap(buf,<span style="color:#ae81ff">0xf0</span>);
      }
      munmap(addr,<span style="color:#ae81ff">0x18</span>);
    }
  }
  _exit(<span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">return</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>The <code>ptrace</code> call is there to prevent attaching to the process with a debugger.</p>
<p>Then, the code allocates two buffers, <code>addr</code> and <code>buf</code>. <code>buf</code> is later used to store
user input (recall that fd 0 is <code>stdin</code>), and it appears that its contents are compared
to those of <code>addr</code>, inside <code>FUN_00000200</code>. A quick look at this function confirms
that it performs string comparison.</p>
<p>Onwards, to find the flag!</p>
<h3 id="a-skip-and-a-hop">A skip and a hop</h3>
<p>So, what&rsquo;s inside <code>FUN_00000285</code>? Let&rsquo;s take a look:</p>
<!-- markdownlint-capture -->
<!-- markdownlint-disable -->
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-1"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-1"> 1</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-2"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-2"> 2</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-3"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-3"> 3</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-4"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-4"> 4</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-5"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-5"> 5</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-6"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-6"> 6</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-7"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-7"> 7</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-8"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-8"> 8</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-9"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-9"> 9</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-10"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-10">10</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-11"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-11">11</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-12"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-12">12</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-13"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-13">13</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-14"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-14">14</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-15"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-15">15</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-16"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-16">16</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-17"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-17">17</a>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-18"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-18">18</a>
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-19"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-19">19</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-20"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-20">20</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-21"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-21">21</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-22"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-22">22</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-23"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-23">23</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-24"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-24">24</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-25"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-25">25</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-26"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-26">26</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-27"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-27">27</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-28"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-28">28</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-29"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-29">29</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-30"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-30">30</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-31"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-31">31</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-32"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-32">32</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-33"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-33">33</a>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="read-flag-34"><a style="outline: none; text-decoration:none; color:inherit" href="#read-flag-34">34</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_flag</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>flag)
{
  <span style="color:#66d9ef">int</span> fd;
  off_t oVar1;
  ssize_t sVar2;
  <span style="color:#66d9ef">int</span> local_8;
  <span style="color:#66d9ef">int</span> local_4;

  local_4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">if</span> (fd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
    write(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;open</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">5</span>);
    local_4 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }
  <span style="color:#66d9ef">else</span> {
    local_8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">while</span> (local_8 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x18</span>) {
<span style="display:block;width:100%;background-color:#3c3d38">      oVar1 <span style="color:#f92672">=</span> lseek(fd,(ulong)<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)local_8 <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1a0</span>),<span style="color:#ae81ff">0</span>);
</span>      <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">int</span>)oVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        write(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;lseek</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">5</span>);
        local_4 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">break</span>;
      }
      sVar2 <span style="color:#f92672">=</span> read(fd,flag <span style="color:#f92672">+</span> local_8,<span style="color:#ae81ff">1</span>);
      <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">int</span>)sVar2 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        local_4 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">break</span>;
      }
      local_8 <span style="color:#f92672">=</span> local_8 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
    }
    close(fd);
  }
  <span style="color:#66d9ef">return</span> local_4;
}</code></pre></td></tr></table>
</div>
</div>
<!-- markdownlint-restore -->
<p>The function opens <code>/lib/x86_64-linux-gnu/libc.so.6</code> and reads <code>0x18</code> bytes from it,
all from different locations. The offsets are calculated on <a href="#read-flag-18">line 18</a>,
but what&rsquo;s going on there?</p>
<p>The strange <code>0x1a0</code> address is actually within the binary, Ghidra just failed to
recognize it as such. In fact, the assembly uses <code>RIP</code>-relative addressing,
so there&rsquo;s no explicit reference to <code>0x1a0</code> anywhere, it&rsquo;s just a by-product
of us loading the binary at address 0 in Ghidra.</p>
<p>So, the offsets to read from are stored in an array:</p>
<p><img src="/img/shabakernel-offsets-array.png" alt="Offsets array"></p>
<p>All we have to do now is get <code>/lib/x86_64-linux-gnu/libc.so.6</code> from the <a href="http://uec-images.ubuntu.com/releases/focal/release-20201210/" title="Ubuntu 20.04 LTS (Focal Fossa) [20201210]">image</a>
and read the bytes at the specified offsets.</p>
<p><code>FIN</code></p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Fun fact: AFAICT, this magic is not validated anywhere in <code>loader.ko</code>.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>I removed a call to <code>__fentry__</code> and some stack cookie checks.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>If, like me, you&rsquo;re using Python, the PyCryptodome library implements RC4
as <a href="https://www.pycryptodome.org/en/latest/src/cipher/arc4.html" title="ARC4 - PyCryptodome 3.9.9 documentation">ARC4</a>.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>The only difference between this and the Ghidra output is the inlining
of string references. Originally, they all appear as <code>s_mmap_0000039c</code>
and the like, or as raw integers when Ghidra fails to recognize them as
addresses in the binary.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

</article>


    </div>
<div class="footer">
    
    
    <div class="footer-links">
        <a href="https://github.com/mbikovitsky">GitHub</a>
        <a href="https://twitter.com/bikodbg">Twitter</a>
    </div>
    

    
    
    <div class="copyright">© 2021 — Michael Bikovitsky — CC BY 4.0</div>
    
</div>
</body>

</html>